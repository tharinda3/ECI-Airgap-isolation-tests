# Docker Enterprise Air-Gapped Containers & ECI Test Suite

Comprehensive security testing for Docker Desktop's enterprise features:
- **Air-gapped Containers**: Network access control via proxy rules and PAC files
- **Enhanced Container Isolation (ECI)**: VM-based container isolation from host

## ğŸ”’ What This Tests

### Air-Gapped Containers (Enterprise Feature)
Tests Docker's enterprise air-gapped container feature that uses:
- Settings Management (`admin-settings.json`) for policy enforcement
- Proxy rules (HTTP/HTTPS/SOCKS5) for traffic routing
- PAC files for fine-grained destination control
- Port filtering via `transparentPorts` configuration

**Not** just `--network none` - this is the full enterprise feature.

### Enhanced Container Isolation (ECI)
Tests VM-based isolation that prevents:
- Host filesystem access
- Host process visibility
- Container escape attempts
- Kernel exploitation

## ğŸ“‹ Prerequisites

### For Air-Gapped Container Tests
- **Docker Business Subscription** (required)
- **Docker Desktop 4.29+**
- **Settings Management** enabled
- **Admin access** to configure `admin-settings.json`

### For ECI Tests
- Docker Desktop (any version with ECI support)
- ECI enabled in Docker Desktop settings

## ğŸš€ Quick Start

```bash
# Clone repository
git clone git@github.com:tharinda3/ECI-Airgap-isolation-tests.git
cd ECI-Airgap-isolation-tests

# Run all tests
./run-all-tests.sh

# Run specific test suites
./tests/airgap/config_tests.sh       # Air-gap configuration tests
./tests/airgap/pac_tests.sh          # PAC file functionality
./tests/airgap/proxy_routing_tests.sh # Proxy routing validation
./tests/eci/filesystem_isolation.sh   # ECI filesystem tests
./tests/eci/process_isolation.sh      # ECI process tests
```

## ğŸ“ Repository Structure

```
.
â”œâ”€â”€ test-plan.md              # Original test plan (basic isolation)
â”œâ”€â”€ test-plan-airgap.md      # Enterprise air-gap feature test plan
â”œâ”€â”€ run-all-tests.sh         # Master test runner
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ airgap/              # Air-gapped container tests
â”‚   â”‚   â”œâ”€â”€ config_tests.sh          # Configuration enforcement
â”‚   â”‚   â”œâ”€â”€ pac_tests.sh             # PAC file rules
â”‚   â”‚   â”œâ”€â”€ proxy_routing_tests.sh   # Proxy routing
â”‚   â”‚   â””â”€â”€ network_isolation.sh     # Basic network tests
â”‚   â”œâ”€â”€ eci/                 # Enhanced Container Isolation tests
â”‚   â”‚   â”œâ”€â”€ filesystem_isolation.sh
â”‚   â”‚   â””â”€â”€ process_isolation.sh
â”‚   â”œâ”€â”€ combined/            # Multi-layer security tests
â”‚   â”‚   â””â”€â”€ multi_layer.sh
â”‚   â””â”€â”€ attacks/             # Attack simulation containers
â”‚       â”œâ”€â”€ crypto_miner.Dockerfile
â”‚       â”œâ”€â”€ data_stealer.Dockerfile
â”‚       â””â”€â”€ container_escape.Dockerfile
â”œâ”€â”€ pac-files/               # Sample PAC files (generated by tests)
â””â”€â”€ config-examples/         # Sample admin-settings.json files
```

## ğŸ”§ Configuration

### Enable Enhanced Container Isolation (ECI)

1. Open Docker Desktop
2. Go to **Settings** â†’ **General**
3. Enable **"Use Enhanced Container Isolation"**
4. Apply & Restart

### Configure Air-Gapped Containers

Air-gapped containers require Settings Management configuration:

**Example: Block all external access**
```json
{
  "configurationFileVersion": 2,
  "containersProxy": {
    "locked": true,
    "mode": "manual",
    "http": "",
    "https": "",
    "exclude": [],
    "transparentPorts": "*"
  }
}
```

**Example: Allow specific domains**
```json
{
  "configurationFileVersion": 2,
  "containersProxy": {
    "locked": true,
    "mode": "manual",
    "http": "",
    "https": "",
    "exclude": ["docker.io", "github.com", "npmjs.com"],
    "transparentPorts": "80,443"
  }
}
```

**Example: Use PAC file**
```json
{
  "configurationFileVersion": 2,
  "containersProxy": {
    "locked": true,
    "mode": "manual",
    "pac": "http://pac-server.company.com/proxy.pac",
    "transparentPorts": "*"
  }
}
```

See [Docker documentation](https://docs.docker.com/enterprise/security/hardened-desktop/air-gapped-containers/) for configuration details.

## ğŸ§ª Test Categories

### 1. Air-Gap Configuration Tests (`tests/airgap/config_tests.sh`)
- Locked configuration enforcement
- Complete network blocking
- Exclude list (allowlist) functionality
- Environment variable override prevention
- Custom network bypass attempts

### 2. PAC File Tests (`tests/airgap/pac_tests.sh`)
- PAC file download and application
- Domain-based rules (`dnsDomainIs`)
- IP-based rules (`isInNet`)
- Port-based filtering
- Path-based matching
- Complex multi-tier routing

### 3. Proxy Routing Tests (`tests/airgap/proxy_routing_tests.sh`)
- HTTP/HTTPS proxy routing
- SOCKS5 proxy support
- Proxy failover handling
- Concurrent connection handling
- Configuration precedence

### 4. ECI Tests
- **Filesystem Isolation**: Host filesystem protection, volume mount boundaries
- **Process Isolation**: Host process visibility, namespace isolation

### 5. Attack Simulations
- Crypto miner with C2 communication attempts
- Multi-vector data exfiltration
- Container escape attempts

## ğŸ“Š Sample Output

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  Air-Gapped Container Configuration Tests                 â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ“ PASS: External HTTP blocked
âœ“ PASS: HTTP and HTTPS blocked
âœ“ PASS: DNS follows air-gap configuration
âœ“ PASS: Localhost communication allowed
âœ“ PASS: Environment variables don't bypass air-gap config
âœ“ PASS: Custom networks don't bypass air-gap rules

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Passed: 8
Failed: 0
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

## ğŸ¯ Testing PAC Files

The test suite includes sample PAC files for common scenarios:

```bash
# Generate sample PAC files
./tests/airgap/pac_tests.sh

# Serve PAC files for testing
cd pac-files
python3 -m http.server 8888

# Or use Docker
docker run -d --name pac-server -p 8888:80 \
  -v $(pwd)/pac-files:/usr/share/nginx/html:ro \
  nginx:alpine
```

Sample PAC files created:
- `block-all.pac` - Block all external access
- `allow-domains.pac` - Allowlist specific domains
- `internal-networks.pac` - Allow internal IP ranges
- `dev-workflow.pac` - Allow development tools
- `corporate-proxy.pac` - Route through corporate proxy

## ğŸ” Verification

### Verify Air-Gap Configuration

```bash
# Should be blocked (if air-gap configured)
docker run --rm alpine wget -O- http://google.com

# Should work (if in exclude list)
docker run --rm alpine wget -O- http://docker.io

# Should work (if allowed by PAC file)
docker pull alpine:latest
```

### Verify ECI

```bash
# Should fail - no host filesystem access
docker run --rm alpine ls /Users

# Should fail - no host process visibility
docker run --rm alpine ps aux | wc -l  # Should show <10 processes

# Should work - container itself functions normally
docker run --rm alpine echo "Container works"
```

## ğŸ“š Documentation

- **[test-plan-airgap.md](test-plan-airgap.md)** - Detailed air-gap test methodology
- **[test-plan.md](test-plan.md)** - ECI and basic isolation tests
- **[README-TESTS.md](README-TESTS.md)** - Original testing guide

## ğŸ” Security Considerations

### Air-Gapped Containers
- Network policies are enforced at Docker Desktop level
- Advanced users may bypass via host networking or other means
- Consider additional network-level controls for high-security environments
- PAC files should be hosted on reliable internal infrastructure
- Test thoroughly before production deployment

### Enhanced Container Isolation
- Provides strong VM-based boundary between containers and host
- Effective against kernel exploits and container escapes
- Some performance overhead due to VM layer
- Works seamlessly with air-gap configuration

## ğŸ¤ Contributing

Contributions welcome! To add tests:

1. Create test script in appropriate directory
2. Follow existing format (colored output, pass/fail tracking)
3. Update test runner to include new tests
4. Document expected behavior
5. Test against actual Docker Desktop configuration

## ğŸ“– References

- [Docker Air-Gapped Containers Documentation](https://docs.docker.com/enterprise/security/hardened-desktop/air-gapped-containers/)
- [Docker Enhanced Container Isolation](https://docs.docker.com/desktop/hardened-desktop/enhanced-container-isolation/)
- [Docker Settings Management](https://docs.docker.com/desktop/hardened-desktop/settings-management/)
- [PAC File Specification](https://en.wikipedia.org/wiki/Proxy_auto-config)

## âš ï¸ Important Notes

1. **Air-gapped containers require Docker Business subscription**
2. Tests assume Settings Management is configured
3. Some tests require manual PAC server setup
4. Results depend on your `admin-settings.json` configuration
5. ECI tests work independently of air-gap configuration
6. Combined tests validate defense-in-depth

## ğŸ“ License

MIT License - See LICENSE file for details

## ğŸ› Security Disclosure

If you discover security issues that bypass Docker Desktop protections, please report responsibly to [Docker Security](https://www.docker.com/security).
